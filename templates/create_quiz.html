{% extends "base.html" %}
{% block title %}Create Quiz - {{ course.course_code }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('teacher_courses') }}">My Courses</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('teacher_course_detail', course_id=course.id) }}">{{ course.course_code }}</a></li>
        <li class="breadcrumb-item active">Create Quiz</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Create Quiz for {{ course.course_code }}</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('create_quiz', course_id=course.id) }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Quiz Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="time_limit" class="form-label">Time Limit (minutes)</label>
                            <input type="number" class="form-control" id="time_limit" name="time_limit" value="30" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="total_marks" class="form-label">Total Marks</label>
                            <input type="number" class="form-control" id="total_marks" name="total_marks" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="due_date" class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" id="due_date" name="due_date">
                        </div>
                    </div>
                    
                    <hr>
                    <h5 class="mb-3">Quiz Questions</h5>
                    
                    <div id="questions-container">
                        <div class="question-card card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Question 1</h6>
                                <button type="button" class="btn btn-sm btn-danger remove-question" disabled>
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Question Text</label>
                                    <textarea class="form-control" name="question_1_text" rows="2" required></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Question Type</label>
                                        <select class="form-select question-type" name="question_1_type" required>
                                            <option value="multiple_choice">Multiple Choice</option>
                                            <option value="true_false">True/False</option>
                                            <option value="short_answer">Short Answer</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Marks</label>
                                        <input type="number" class="form-control" name="question_1_marks" value="1" min="1" required>
                                    </div>
                                </div>
                                
                                <div class="multiple-choice-options">
                                    <label class="form-label">Options</label>
                                    <div class="mb-2">
                                        <div class="input-group">
                                            <span class="input-group-text">A</span>
                                            <input type="text" class="form-control" name="question_1_option_A" placeholder="Option A">
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <div class="input-group">
                                            <span class="input-group-text">B</span>
                                            <input type="text" class="form-control" name="question_1_option_B" placeholder="Option B">
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <div class="input-group">
                                            <span class="input-group-text">C</span>
                                            <input type="text" class="form-control" name="question_1_option_C" placeholder="Option C">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text">D</span>
                                            <input type="text" class="form-control" name="question_1_option_D" placeholder="Option D">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Correct Answer</label>
                                    <input type="text" class="form-control" name="question_1_correct_answer" required>
                                    <div class="form-text">For multiple choice, enter the correct letter (A, B, C, or D)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="question_count" name="question_count" value="1">
                    
                    <div class="d-grid gap-2 mb-3">
                        <button type="button" id="add-question" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Add Another Question
                        </button>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Create Quiz</button>
                        <a href="{{ url_for('teacher_course_detail', course_id=course.id) }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let questionCount = 1;
    const questionsContainer = document.getElementById('questions-container');
    const questionCountInput = document.getElementById('question_count');
    const addQuestionBtn = document.getElementById('add-question');
    
    // Add question button handler
    addQuestionBtn.addEventListener('click', function() {
        questionCount++;
        questionCountInput.value = questionCount;
        
        const newQuestion = document.createElement('div');
        newQuestion.className = 'question-card card mb-3';
        newQuestion.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Question ${questionCount}</h6>
                <button type="button" class="btn btn-sm btn-danger remove-question">
                    <i class="bi bi-trash"></i> Remove
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea class="form-control" name="question_${questionCount}_text" rows="2" required></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Question Type</label>
                        <select class="form-select question-type" name="question_${questionCount}_type" required>
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="short_answer">Short Answer</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Marks</label>
                        <input type="number" class="form-control" name="question_${questionCount}_marks" value="1" min="1" required>
                    </div>
                </div>
                
                <div class="multiple-choice-options">
                    <label class="form-label">Options</label>
                    <div class="mb-2">
                        <div class="input-group">
                            <span class="input-group-text">A</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_A" placeholder="Option A">
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="input-group">
                            <span class="input-group-text">B</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_B" placeholder="Option B">
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="input-group">
                            <span class="input-group-text">C</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_C" placeholder="Option C">
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text">D</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_D" placeholder="Option D">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Correct Answer</label>
                    <input type="text" class="form-control" name="question_${questionCount}_correct_answer" required>
                    <div class="form-text">For multiple choice, enter the correct letter (A, B, C, or D)</div>
                </div>
            </div>
        `;
        
        questionsContainer.appendChild(newQuestion);
        
        // Enable remove buttons if there's more than one question
        if (questionCount > 1) {
            document.querySelectorAll('.remove-question').forEach(btn => {
                btn.disabled = false;
            });
        }
        
        // Add event listener to the new remove button
        newQuestion.querySelector('.remove-question').addEventListener('click', function() {
            newQuestion.remove();
            questionCount--;
            questionCountInput.value = questionCount;
            
            // Disable remove buttons if there's only one question left
            if (questionCount === 1) {
                document.querySelector('.remove-question').disabled = true;
            }
            
            // Renumber questions
            document.querySelectorAll('.question-card').forEach((card, index) => {
                const header = card.querySelector('.card-header h6');
                header.textContent = `Question ${index + 1}`;
            });
        });
        
        // Add event listener to the new question type selector
        newQuestion.querySelector('.question-type').addEventListener('change', function() {
            toggleOptionsVisibility(this);
        });
    });
    
    // Remove question button handler
    document.querySelectorAll('.remove-question').forEach(btn => {
        btn.addEventListener('click', function() {
            if (questionCount > 1) {
                this.closest('.question-card').remove();
                questionCount--;
                questionCountInput.value = questionCount;
                
                // Disable remove buttons if there's only one question left
                if (questionCount === 1) {
                    document.querySelector('.remove-question').disabled = true;
                }
                
                // Renumber questions
                document.querySelectorAll('.question-card').forEach((card, index) => {
                    const header = card.querySelector('.card-header h6');
                    header.textContent = `Question ${index + 1}`;
                });
            }
        });
    });
    
    // Toggle options visibility based on question type
    function toggleOptionsVisibility(selectElement) {
        const optionsDiv = selectElement.closest('.card-body').querySelector('.multiple-choice-options');
        if (selectElement.value === 'multiple_choice') {
            optionsDiv.style.display = 'block';
        } else {
            optionsDiv.style.display = 'none';
        }
    }
    
    // Initialize options visibility
    document.querySelectorAll('.question-type').forEach(select => {
        toggleOptionsVisibility(select);
        select.addEventListener('change', function() {
            toggleOptionsVisibility(this);
        });
    });
});
</script>
{% endblock %}